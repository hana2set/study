# Production ML System
## 정적 vs. 동적 훈련

- 정적 학습(오프라인 학습): (모델을) 한 번만 학습.
- 동적 학습(온라인 학습): 지속적으로 학습.

  | 구분       | 정적 훈련                                             | 동적 훈련                                                             |
  |------------|-----------------------------------------------------------|------------------------------------------------------------------------|
  | **장점**   | **더 간단함·저렴함** <br> 모델을 한 번만 개발하고 테스트 | **적응력이 높음**. <br> 특성과 레이블 간의 관계 변경에도 적응 |
  | **단점**   | **낡을 수 있음**.<br> 시간에 따라 모델의 예측 성능이 저하될 수 있음 | **작업량이 많아짐**. <br> 항상 모델을 개발·테스트·출시         |

##  정적 vs. 동적 추론
> 추론: 레이블이 지정되지 않은 사례를 예측하는 과정
- 정적 추론(오프라인 추론, 일괄추론): 모델이 일련의 레이블이 지정되지 않는 예제를 예측한 다음 어딘가에 캐시함
- 동적 추론(온라인 추론): 모델이 클라이언트가 예측을 요청할 때 바로 예측을 수행
  
  | 구분       | 정적 추론                                                                                     | 동적 추론                                                                                                   |
  |------------|-----------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------------|
  | **장점**   | - 추론 비용이 작음<br>- 푸시 전 예측의 사후 검증을 수행 가능 | - 롱테일(일반적이지 않은) 예측에 적합         |
  | **단점**   | - 드문 예제에 대한 예측 어려움<br>- 업데이트 지연 시간이 길 수 있음 | - 모델 복잡성이 제한됨(작아야함)<br>- 모니터링 필요성이 더 큼 |

## 데이터 변환 시기 (transform data)
- 원시 데이터는 특성 엔지니어링(변환) 되어야함.
  - 훈련 전 (before training)
  - 훈련 중 (While training)

    | 구분               | 훈련 전 (before)                                                                                                                   | 훈련 중 (While)                                                                                    |
    |--------------------|-------------------------------------------------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------|
    | **방법**           | 1. 원시 데이터를 변환하기 위해 코드나 특수한 도구를 사용<br>2. 변환된 데이터를 저장함 (모델이 수집할 수 있는 디스크 같은 곳에)                     | - 모델 코드 내에서 원시 데이터를 직접 수집하고 변환                                                       |
    | **장점**           | - 원시 데이터를 한 번만 변환하면 됨<br>- 전체 데이터 세트를 분석해 최적의 변환 전략을 선택 가능                                      | - 변환이 바뀌어도 동일한 원시 데이터를 계속 사용할 수 있음<br>- 훈련 및 예측 시 동일한 변환이 보장됨     |
    | **단점**           | - 예측 시점에 변환을 다시 생성해야 하므로 **학습-서빙 편향**에 주의 필요                                                            | - 복잡한 변환은 모델 지연 시간을 증가시킬 수 있음<br>- 각 배치마다 변환이 반복 수행되어 오버헤드 발생     |

> **학습-서빙 편향** (Training-serving skew): 같은 모델의 훈련 중일 때, 서비스 중일 때의 성능 차이를 의미.   
> 동적 추론을 수행할 때 더 위험함. (발생할 위험도 높고, 발생하면 검증없이 즉시 반영되기 때문)


## 배포 테스트
머신러닝 시스템 배포에 필요한 테스트 종류
- 입력 데이터 검증
- 특징 엔지니어링 검증
- 새로운 모델 품질 검증
- 서비스 인프라 검증
- 파이프라인 구성 요소 간 통합 테스트

많은 소프트 엔지니어가 TDD를 선호하지만, 머신러닝에서는 까다롭다! (학습 시키기 전 손실 검증 테스트? 불가능)

### 재현 가능한 훈련으로 테스트
특정 변경에 대한 내용을 확인하기 위해 같은 내용을 재학습하여 비슷한 결과를 보고 싶을 때가 있음.  
하지만 모델 학습을 재현하는 것은 어려울 때가 많음.  
다음과 같은 방법으로 재현성을 높일 수 있음.
- 난수 생성기를 결정론적으로 시딩 (시드 고정)
- 모델 구성 요소를 고정된 순서로 초기화 (보통 ML 라이브러리가 자동으로 처리)
- 모델을 여러번 실행하여 평균 계산
- 버전 제어 사용

### 머신 러닝 API 호출에 대한 테스트
- 문제: 모델 API 업데이트 후 성능을 검증하려면 전체 재학습이 필요하지만, 이는 비용(시간)이 큼.
- 전략:
  1. 무작위 입력 데이터를 생성하고,
  2. **경사하강법**의 한 단계 또는 예측 함수 호출을 실행해,
  3. 오류가 없는지 테스트하는 **단위 테스트**를 작성.
- 의미:
  - 학습/추론 로직이 깨지지 않았는지를 검증하는 **빠르고 저비용의 안정성 검사**
  - 정상 실행 여부만 판   

### 파이프 라인 구성 요소에 대한 테스트
- 문제: ML 파이프라인은 서로 연결된 다수의 구성 요소로 구성되며, 하나의 변경이 다른 부분에 영향을 줄 수 있음.
- 전략:
  - **전체 파이프라인을 엔드 투 엔드로 실행하는 통합 테스트** 작성.
  - 새 모델 및 소프트웨어 버전 푸시 시마다 테스트 수행.
  - 전체 실행이 느릴 경우:
    - 샘플 데이터나 단순 모델을 활용해 빠른 테스트 수행.
    - 느린 테스트는 백그라운드에서 주기적으로 수행.
- 일반적으로 CI/CD 파이프라인에 통합

### 서비스 제공 전 
- 모델 품질 검증 (두 가지 품질 저하 테스트)
  - 급격한 성능 저하
  - 느린 성능 저하
    - 점차 느려지는 것을 감지하기 어려움. 따라서 임계값을 정하고 그 값을 충족하는지 확인
- 모델-인프라 호환성 검증
  - 스테이징(샌드박싱) 환경에서 테스트


## 파이프라인 모니터링

### 데이터 스키마 작성
원시 데이터의 유효성을 검사해야함. 따라서 데이터 스키마를 작성 후 지속적으로 데이터와 비교.  
- **특성의 범위와 분포**를 정의. (범주형 특성은 **값의 집합**)
- 데이터 오류
  - 이상치
  - 예상하지 않는 범주
  - 예상하지 않은 분포

### 특성 엔지니어링 검증
**단위 테스트 작성**으로 검증
- 숫자형 데이터 범주
- 원핫 인코딩된 벡터의 범위 (0, 1으로 구성)
- 변환 후 데이터 분포 예상 (예를 들어, Z-점수의 평균은 0)
- 클리핑, 스케일링을 통한 이상치 처리
  

### 중요한 데이터 슬라이스에 대한 행렬 확인
> 데이터 슬라이스: 데이터의 하위 집합
중요한(관심도 높은)데이터 슬라이스에 대한 예측을 추적하고 확인할 것. (편항 제거에 도움)

### 실제 지표를 사용하여 검증
- 실제 영향을 확인하려면 실제의 별도 지표를 활용해야 함.
- 예: 모델 사용자를 대상으로 설문조사 실시

### 훈련-서빙 편향을 확인
- 편향 유형

  | Type           | Definition                                                       | Example                                                                 | Solution                                                                                                                                                   |
  |----------------|------------------------------------------------------------------|-------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------|
  | 스키마 왜    | 훈련-서비스 입력 데이터의 동일 스키마가 다름 | 모델이 학습하는 동안 제공 데이터의 형식, 분포가 계속 변경됨         | - 동일한 스키마를 사용하여 유효성 검증.<br>- 스키마에서 확인하지 않는 통계 직접 확인 |
  | 특징 왜곡   | 훈련-서비스 입력 데이터가 다름            | 특성 엔지니어링 코드가 다르므로, 다른 데이터가 생성됨            | - 탐지된 편향 특징의 수와 비율을 추적. |


### label 유출을 확인
- 예측하려는 label이 학습 feature에 입력되는 것

### 파이프라인 전반적인 모델 연령 모니터링
모델은 정적으로 재학습이 필요 (시간에 따른 데이터 변화)  
따라서 **파이프라인 전체에 걸쳐 모델 발생 시점을 모니터링 해야함.**

### 가중치와 출력이 수치적으로 안정적인지 확인
가중치나 계층 출력이 NaN, Inf, 0(절반 이상) 인지 테스트를 작성할 것

### 모델 성능 모니터링
- 코드, 모델, 데이터 버전별로 성능 추적. (성능 저하의 원인 파악 용이)
- 이전 버전과 고정된 기준값에 대한 `새로운 모델 버전의 "훈련의 초당 스텝"(steps per second)`를 비교하여 테스트할 것.
- 메모리 사용에 대한 임계값 설정 (누수 방지)
- API 응답시간 모니터링, 백분위수 추적 (느린 응답은 지표에 부정적인 영향이 있음)
- 초당 응답되는 쿼리 수 모니터링

### 라이브 모델 품질 테스트 
label이 없는 실제 데이터
- 사람이 label 생성 고려
- 유의미한 예측 편향을 보이는 모델 조사
- 모델의 실제 지표 추적 (실제와 예측 결과 비교)
- 일부 쿼리에 대해 새 모델을 제공하여 점진적 전환  

테스트 도중 품질 저하에 대해 모니터링 해야함.

### 무작위화
**데이터 생성 파이프라인을 재현 가능하게 만들 것**
- 난수 생성기에 시드 적용
- 불변 해시 키 사용

#### 해싱에 대한 고려 사항
항상 같은 데이터로 테스트 -> 좋지않음  
해싱에 시간 데이터 포함할 것 (매일 다른 해싱)
- 덜 다양한 쿼리 세트
- 다른 데이터 세트를 사용함으로, 실제 제공 시점에 일부 실시간 트래픽 반영됨

  ![hashing_on_query](https://github.com/user-attachments/assets/aea0bf3b-ee18-4132-9a84-7d42d2295b7d)


---

출처:  
[프로덕션 ML 시스템](https://developers.google.com/machine-learning/crash-course/production-ml-systems/monitoring)
